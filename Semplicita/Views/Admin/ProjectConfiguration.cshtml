@using Semplicita.Models
@using Semplicita.Helpers
@model ServerConfigViewModel

@{
    ViewBag.Title = "Configure Project Behavior";

    var projectHelper = new ProjectHelper();
    var roleHelper = new PermissionsHelper();
    var roleDisplays = new RoleDisplayDictionary();

}

<div class="jumbotron">
    <h1>Configure Project Behavior</h1>
    <p class="lead">Here you can manipulate the flow of how tickets reach completion within projects.</p>
</div>

@* Help *@
<div class="row">
    <div class="col-xl-12 p-3">
        <div class="card card-default collapsed-card" id="userAssignRoleCard">
            <div class="card-header" style="background-color:#C8E7FF">
                <h2 class="card-title"><i class="far fa-question-circle" style="margin-right:10px;color:#1B1075"></i><b>Help:</b> - Projects &amp; Workflows</h2>

                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="card-body">
                <p>
                    Projects sort tickets and issues to similar systems that exhibit the problems generated by reporters. Projects ensure that the correct
                    solvers and managers are handling issues that they are responsible for solving, and to ensure that job duties are not mixed up amongst the
                    solvers and reporters.
                </p>
                <p>
                    Workflows are sets of parameters applied to projects that define how tickets behave until they're closed. Workflows control who
                    gets assigned to tickets upon their creation, how long tickets can stay in certain statuses before actions are taken, and help control the
                    options avaialble to Reporters and Solvers working within the project.
                </p>
            </div>
        </div>
    </div>
</div>

@* Tables *@
<div class="row">

    @* Projects Summary *@
    <div class="col-xl-12 p-3">
        <div class="card card-default">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-table" style="margin-right:10px;"></i><b>Projects</b></h3>

                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                </div>
            </div>

            <div class="card-body">
                <table id="projtable" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date Created</th>
                            <th>Primary Manager</th>
                            <th>Total Members</th>
                            <th>Active Workflow</th>
                            <th>Total Tickets</th>
                            <th>Open Tickets</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach( Project p in Model.Projects ) {
                            <tr>
                                <td>@p.Name</td>
                                <td>@p.CreatedAt.ToString("M/d/yyyy")</td>
                                <td>@(p.ProjectManagerId == null ? "None" : Model.Users.FirstOrDefault(u => u.Id == p.ProjectManagerId).FullNameStandard)</td>
                                <td>@(p.Members.Count)</td>
                                <td>@(p.ActiveWorkflow == null ? "No" : p.ActiveWorkflow.Name)</td>
                                <td>@p.ChildTickets.Count</td>
                                <td>@p.ChildTickets.Select(t => t.TicketStatus.IsClosed == false).Count()</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@* Forms *@
<div class="row">

    @* Change Project Workflow *@
    <div class="col-xl-6">
        <form action="" method="post">
            @Html.AntiForgeryToken()
            @Html.Hidden("ReturningViewName", "ProjectConfiguration")
            <div class="card card-default collapsed-card" id="projAssignWorkflowCard">
                <div class="card-header" style="background-color:#F0F0F0">
                    <h3 class="card-title"><i class="fas fa-code-branch" style="margin-right:10px; width: 18px;"></i><b>Change Project Workflow</b></h3>

                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-plus" id="projAssignWorkflowCollapseIcon"></i></button>
                    </div>
                </div>

                <div class="card-body">
                    <p>Workflows help tickets along through projects by giving them triggers to automatic behavior based on certain actions/criteria.</p>
                    <p><small>If you would like to create a new workflow to add to a project, you can click here, and select projects to apply the new workflow to there.</small></p>
                    <hr />
                    @if( ViewBag.ProjWorkflowAssignErrors != null ) {
                        <ul>
                            @foreach( string err in ViewBag.ProjWorkflowAssignErrors ) {
                                <li class="text-danger">@err</li>
                            }
                        </ul>
                    }
                    @if( ViewBag.ProjWorkflowAssignMessages != null ) {
                        <div class="row">
                            <ul>
                                @foreach( string msg in ViewBag.ProjWorkflowAssignMessages ) {
                                    <li class="text-success">@msg</li>
                                }
                            </ul>
                        </div>
                    }

                    <div class="form-group">

                        <div class="row p-1">
                            <div class="col-12">
                                <h5>Step 1: Select Projects</h5>
                                <div class="select2-purple">
                                    <select name="ProjectIds" class="select2" multiple="multiple" data-placeholder="Select or Type Project Name..." hidden="hidden" data-dropdown-css-class="select2-purple" style="width: 100%; height: 38px;">
                                        @foreach( Project p in Model.Projects.Where(p => p.IsActiveProject == true).ToList() ) {
                                            <option value="@p.Id">@p.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row p-1">
                            <div class="col-12">
                                <h5>Step 2: Select Workflow</h5>
                                <div class="select2-purple">
                                    <select name="WorkflowId" class="select2" data-placeholder="Select or Type Workflow..." data-dropdown-css-class="select2-purple" style="width: 100%; height: 38px;">
                                        @foreach( ProjectWorkflow pwf in Model.Workflows ) {
                                            <option value="@pwf.Id">@pwf.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="col">
                        <div class="row">
                            <div class="col">
                                <input type="submit" name="projWorkflow:Set" value="Set Workflow" class="btn btn-success btn-block" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    @* Add/Remove Users from Projects *@
    <div class="col-xl-6">
        <form action="" method="post">
            @Html.AntiForgeryToken()
            @Html.Hidden("ReturningViewName", "ProjectConfiguration")
            <div class="card card-default collapsed-card" id="userAssignProjectCard">
                <div class="card-header" style="background-color:#F0F0F0">
                    <h3 class="card-title"><i class="fas fa-user-plus" style="margin-right:10px; width: 18px;"></i><b>Add/Remove Users from Projects</b></h3>

                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-plus" id="userAssignProjectCardCollapseIcon"></i></button>
                    </div>
                </div>

                <div class="card-body">
                    <p>To add/remove users to/from projects, please enter their full names and the name of projects you wish to add/remove them from.</p>
                    <hr />
                    @if( ViewBag.UserProjectAllocErrors != null ) {
                        <ul>
                            @foreach( string err in ViewBag.UserProjectAllocErrors ) {
                                <li class="text-danger">@err</li>
                            }
                        </ul>
                    }
                    @if( ViewBag.UserProjectAllocMessages != null ) {
                        <ul>
                            @foreach( string msg in ViewBag.UserProjectAllocMessages ) {
                                <li class="text-success">@msg</li>
                            }
                        </ul>
                    }

                    <div class="form-group">

                        <div class="row p-1">
                            <div class="col-12">
                                <h5>Step 1: Select Users</h5>
                                <div class="select2-purple">
                                    <select class="select2" multiple="multiple" data-placeholder="Select or Type Name..." hidden="hidden" data-dropdown-css-class="select2-purple" style="width: 100%;" name="UserIds">
                                        @foreach( ApplicationUser u in Model.Users.OrderBy(u => u.LastName) ) {
                                            <option value="@u.Id">@u.FullNameStandard</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row p-1">
                            <div class="col-12">
                                <h5>Step 2: Select Projects</h5>
                                <div class="select2-purple">
                                    <select class="select2" multiple="multiple" data-placeholder="Select or Type Project Name..." hidden="hidden" data-dropdown-css-class="select2-purple" style="width: 100%;" name="ProjectIds">
                                        @foreach( Project p in Model.Projects ) {
                                            <option value="@p.Id">@p.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="row p-1">
                        <div class="col-xl-6">
                            <input type="submit" name="projectUsers:Remove" value="Remove User(s)" class="btn btn-danger btn-block" />
                        </div>
                        <div class="col-xl-6">
                            <input type="submit" name="projectUsers:Add" value="Add User(s)" class="btn btn-success btn-block" />
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {

    @*navbar selection update*@
    <script>
        $("#navAdminFolder").addClass("menu-open");

        $("#navAdmin").addClass("active");
        $("#navAdminFolder").addClass("active");
        $("#navAdmin_Projects").addClass("active");
    </script>

    @*select2 Init*@
    <script>
        $(document).ready(function () {
            //Initialize Select2 Elements
            $('.select2').select2()

            //Initialize Select2 Elements
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            })

        })
    </script>

    @*DataTable Init*@
    <script>
        $("#projtable").DataTable();
    </script>

    @*if project allocation messages contain values, unhide the project allocation card, and scroll to it*@
    @if( ViewBag.UserProjectAllocMessages != null || ViewBag.UserProjectAllocErrors != null ) {
        <script>
            $("#userAssignProjectCardCollapseIcon").removeClass("fa-plus");
            $("#userAssignProjectCardCollapseIcon").addClass("fa-minus");
            $("#userAssignProjectCard").removeClass("collapsed-card");

            document.getElementById("userAssignProjectCard").scrollIntoView();
        </script>
    }

    @*if user role messages contain values, unhide the project allocation card, and scroll to it*@
    @if( ViewBag.ProjWorkflowAssignErrors != null || ViewBag.ProjWorkflowAssignMessages != null ) {
        <script>
            $("#projAssignWorkflowCollapseIcon").removeClass("fa-plus");
            $("#projAssignWorkflowCollapseIcon").addClass("fa-minus");
            $("#projAssignWorkflowCard").removeClass("collapsed-card");

            document.getElementById("projAssignWorkflowCard").scrollIntoView();
        </script>
    }

}